<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: rgb(52,164,220); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); }
        .header-info { background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #e0e0e0; border-radius: 15px; background: #fff; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .section h2 { color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        button { padding: 12px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        button:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3); }
        .success-btn { background: #28a745; }
        .success-btn:hover { background: #1e7e34; }
        .warning-btn { background: #ffc107; color: #000; }
        .warning-btn:hover { background: #e0a800; }
        .danger-btn { background: #dc3545; }
        .danger-btn:hover { background: #c82333; }
        .post-item { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #007bff; transition: transform 0.2s; }
        .post-item:hover { transform: translateX(5px); }
        .assignment-item { margin: 15px 0; padding: 20px; border: 1px solid #ddd; border-radius: 15px; background: linear-gradient(135deg, #fff, #f8f9fa); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); transition: transform 0.3s; }
        .assignment-item:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }
        .assignment-item h4 { color: #007bff; margin-bottom: 10px; }
        .question-item { margin: 20px 0; padding: 20px; border: 1px solid #e0e0e0; border-radius: 10px; background: #f9f9f9; }
        .question-item h4 { color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
        .option-item { margin: 10px 0; padding: 10px; border-radius: 8px; transition: background-color 0.2s; }
        .option-item:hover { background-color: #e9ecef; }
        .option-item input[type="radio"] { margin-right: 10px; width: auto; }
        .option-item label { margin-bottom: 0; cursor: pointer; display: flex; align-items: center; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: white; padding: 30px; border-radius: 20px; max-width: 90%; max-height: 90%; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .result-display { margin: 15px 0; padding: 15px; border-radius: 10px; border-left: 4px solid; }
        .correct { background: #d4edda; border-color: #28a745; color: #155724; }
        .incorrect { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-completed { background: #cce5ff; color: #004085; }
        .score-display { text-align: center; padding: 20px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; border-radius: 15px; margin-bottom: 20px; }
        .score-display h4 { font-size: 24px; margin-bottom: 10px; }
        .assignment-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #e0e0e0; }
        .timer { position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 10px 15px; border-radius: 25px; font-weight: bold; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3); z-index: 1001; }
        .controls { text-align: center; margin: 20px 0; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .no-assignments { text-align: center; padding: 40px; color: #666; }
        .no-assignments::before { content: "üìù"; font-size: 48px; display: block; margin-bottom: 15px; }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .results-table th, .results-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .results-table th { background-color: #f2f2f2; }

        /* Progress Card Styles */
        .progress-card-item { 
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e5e7eb;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #10b981;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .progress-card-item:hover { 
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .progress-card-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        .progress-card-header h4 { 
            color: #1e293b;
            font-size: 1.3rem;
            margin: 0;
        }
        .student-info-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .info-item { 
            background: rgba(248, 250, 252, 0.7);
            padding: 12px;
            border-radius: 8px;
        }
        .info-item strong { 
            display: block;
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        .subjects-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .subject-card { 
            background: rgba(248, 250, 252, 0.7);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        .subject-card h5 { 
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        .marks-display { 
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .percentage-display { 
            color: #64748b;
            margin-bottom: 8px;
        }
        .grade-badge { 
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.85rem;
            text-transform: uppercase;
        }
        .grade-aplus { background: #dcfce7; color: #166534; }
        .grade-a { background: #dbeafe; color: #1e40af; }
        .grade-bplus { background: #fef3c7; color: #92400e; }
        .grade-b { background: #fed7aa; color: #9a3412; }
        .grade-cplus { background: #fde68a; color: #a16207; }
        .grade-c { background: #fecaca; color: #b91c1c; }
        .grade-d { background: #fecaca; color: #991b1b; }
        .grade-f { background: #fee2e2; color: #7f1d1d; }
        .overall-performance { 
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }
        .overall-performance h4 { 
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        .overall-stats { 
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .overall-stat { 
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
        }
        .overall-stat strong { 
            display: block;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        .additional-info { 
            background: rgba(248, 250, 252, 0.7);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #6366f1;
        }
        .additional-info h5 { 
            color: #1e293b;
            margin-bottom: 10px;
        }
        .no-progress-cards { 
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .no-progress-cards::before { 
            content: "üìä";
            font-size: 48px;
            display: block;
            margin-bottom: 15px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .student-info-grid { grid-template-columns: 1fr; }
            .subjects-grid { grid-template-columns: repeat(2, 1fr); }
            .overall-stats { grid-template-columns: 1fr; }
            .assignment-stats { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            .subjects-grid { grid-template-columns: 1fr; }
            .assignment-stats { grid-template-columns: 1fr; }
        }
        /* Modal Fixes - Ensure modals stay in fixed position */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-fixed {
    position: relative;
    background-color: #fefefe;
    margin: 2% auto;
    padding: 20px;
    border: none;
    width: 90%;
    max-width: 800px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    max-height: 90vh;
    overflow-y: auto;
}

/* Progress Card Styles for Faculty */
.progress-card-item {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.progress-card-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
}

.progress-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    padding-bottom: 10px;
}

.progress-card-header h4 {
    margin: 0;
    font-size: 1.3em;
    font-weight: 600;
}

.exam-type {
    background: rgba(255, 255, 255, 0.2);
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.9em;
    font-weight: 500;
}

.progress-card-details {
    margin-bottom: 15px;
}

.progress-card-details p {
    margin: 5px 0;
    opacity: 0.9;
}

.subjects-display {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.subject-mark {
    background: rgba(255, 255, 255, 0.15);
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.85em;
    font-weight: 500;
    backdrop-filter: blur(10px);
}

/* Progress Card Form Styles */
.subjects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.subject-item {
    display: flex;
    flex-direction: column;
}

.subject-item label {
    font-weight: 600;
    margin-bottom: 5px;
    color: #333;
}

.subject-item input {
    padding: 10px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.subject-item input:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Student Progress Card Styles */
.my-progress-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.my-progress-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.card-header h4 {
    margin: 0;
    font-size: 1.2em;
    font-weight: 600;
}

.percentage {
    font-size: 1.5em;
    font-weight: bold;
    padding: 8px 15px;
    border-radius: 20px;
    backdrop-filter: blur(10px);
}

.percentage.pass {
    background: rgba(40, 167, 69, 0.3);
    color: #28a745;
}

.percentage.fail {
    background: rgba(220, 53, 69, 0.3);
    color: #dc3545;
}

.card-body p {
    margin: 8px 0;
    opacity: 0.9;
}

.card-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    text-align: center;
}

.card-footer small {
    opacity: 0.7;
    font-style: italic;
}

.no-progress-card {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    padding: 40px 20px;
    text-align: center;
    color: #6c757d;
    font-size: 1.1em;
}

/* Progress Card Detail Modal */
.progress-card-detail {
    background: white;
    border-radius: 15px;
    overflow: hidden;
}

.student-info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    margin: -20px -20px 20px -20px;
}

.student-info h4 {
    margin: 0 0 15px 0;
    font-size: 1.5em;
    font-weight: 700;
}

.student-info p {
    margin: 8px 0;
    opacity: 0.9;
}

.marks-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.summary-item {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.summary-item h5 {
    margin: 0 0 10px 0;
    color: #6c757d;
    font-size: 0.9em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.summary-item .marks,
.summary-item .percentage,
.summary-item .grade {
    font-size: 1.5em;
    font-weight: bold;
    display: block;
}

.summary-item .percentage.pass,
.summary-item .grade.pass {
    color: #28a745;
}

.summary-item .percentage.fail,
.summary-item .grade.fail {
    color: #dc3545;
}

.subjects-detail h5 {
    margin: 0 0 15px 0;
    color: #333;
    font-size: 1.2em;
    font-weight: 600;
    border-bottom: 2px solid #667eea;
    padding-bottom: 8px;
}

.subjects-detail .subjects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.subject-detail {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

.subject-name {
    font-weight: 600;
    color: #333;
    flex: 1;
}

.subject-marks {
    font-weight: bold;
    color: #495057;
    margin: 0 10px;
}

.subject-percentage {
    font-weight: bold;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.85em;
}

.subject-percentage.pass {
    background: #d4edda;
    color: #155724;
}

.subject-percentage.fail {
    background: #f8d7da;
    color: #721c24;
}

.card-date {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #dee2e6;
    text-align: center;
    color: #6c757d;
}

/* Button Styles */
.primary-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.primary-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

/* Error and Success Messages */
.error-msg {
    background: #f8d7da;
    color: #721c24;
    padding: 12px 15px;
    border-radius: 8px;
    margin: 10px 0;
    border: 1px solid #f5c6cb;
}

.success-msg {
    background: #d4edda;
    color: #155724;
    padding: 12px 15px;
    border-radius: 8px;
    margin: 10px 0;
    border: 1px solid #c3e6cb;
}

/* Responsive Design */
@media (max-width: 768px) {
    .modal-fixed {
        width: 95%;
        margin: 5% auto;
        padding: 15px;
        max-height: 85vh;
    }
    
    .subjects-grid {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .marks-summary {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .progress-card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .subjects-display {
        justify-content: flex-start;
    }
    
    .subject-detail {
        flex-direction: column;
        text-align: center;
        gap: 8px;
    }
}

@media (max-width: 480px) {
    .modal-fixed {
        width: 98%;
        margin: 2% auto;
        padding: 10px;
    }
    
    .student-info {
        margin: -10px -10px 15px -10px;
        padding: 20px 15px;
    }
    
    .student-info h4 {
        font-size: 1.3em;
    }
    
    .percentage {
        font-size: 1.2em;
        padding: 6px 12px;
    }
}

/* Loading and Error States */
.loading {
    text-align: center;
    padding: 20px;
    color: #6c757d;
    font-style: italic;
}

.error {
    background: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #f5c6cb;
}

/* Animation for progress cards */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.my-progress-card,
.progress-card-item {
    animation: slideInUp 0.5s ease forwards;
}

/* Print Styles for Progress Cards */
@media print {
    .progress-card-detail {
        box-shadow: none;
        border: 1px solid #ddd;
    }
    
    .student-info {
        background: #f8f9fa !important;
        color: #333 !important;
    }
    
    .modal-fixed {
        box-shadow: none;
        border: 1px solid #ddd;
    }
    
    .primary-btn,
    .danger-btn {
        display: none;
    }
}
.student-profile {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.student-profile .avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #10b981, #059669);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.profile-info h1 {
    margin: 0;
    color: #1e293b;
}

.profile-info h3 {
    margin: 0.5rem 0 0.25rem 0;
    color: #374151;
    font-size: 1.2rem;
}

.profile-info p {
    margin: 0.25rem 0;
    color: #64748b;
    font-size: 0.95rem;
}

.profile-info p strong {
    color: #374151;
}

.info-btn {
    background: linear-gradient(135deg, #06b6d4, #0891b2) !important;
    color: white !important;
    box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3) !important;
}

.info-btn:hover {
    box-shadow: 0 8px 20px rgba(6, 182, 212, 0.4) !important;
}

@media (max-width: 768px) {
    .student-profile {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
    }
    
    .student-profile .avatar {
        width: 50px;
        height: 50px;
        font-size: 1.3rem;
    }
}

    </style>
     <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: rgb(52,164,220);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 15px;
        }

        .student-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            background-size: cover;
            background-position: center;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .profile-info h1 {
            color: #333;
            margin-bottom: 5px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .section {
            background: white;
            margin: 20px 0;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }

        .error {
            text-align: center;
            color: #dc3545;
            padding: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-fixed {
            max-width: 900px;
        }

        .timer {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background-color 0.3s;
        }

        .primary-btn {
            background: #007bff;
            color: white;
        }

        .primary-btn:hover {
            background: #0056b3;
        }

        .success-btn {
            background: #28a745;
            color: white;
        }

        .success-btn:hover {
            background: #1e7e34;
        }

        .warning-btn {
            background: #ffc107;
            color: #212529;
        }

        .warning-btn:hover {
            background: #d39e00;
        }

        .danger-btn {
            background: #dc3545;
            color: white;
        }

        .danger-btn:hover {
            background: #c82333;
        }

        .info-btn {
            background: #17a2b8;
            color: white;
        }

        .info-btn:hover {
            background: #117a8b;
        }

        .fee-btn {
            background: #6f42c1;
            color: white;
        }

        .fee-btn:hover {
            background: #563d7c;
        }

        .assignment-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            background: #fff;
        }

        .assignment-item h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .progress-card, .attendance-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
            cursor: pointer;
            transition: box-shadow 0.2s;
        }

        .progress-card:hover, .attendance-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .certificate-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            font-family: 'Times New Roman', serif;
            border: 3px solid #2c3e50;
            position: relative;
        }

        .certificate-header {
            text-align: center;
            border-bottom: 3px solid #2c3e50;
            padding-bottom: 20px;
            margin-bottom: 30px;
            position: relative;
        }

        .school-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            display: block;
            border-radius: 50%;
            object-fit: contain;
        }

        .school-name {
            margin: 0;
            color: #2c3e50;
            font-size: 28px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .school-address {
            margin: 5px 0;
            color: #34495e;
            font-size: 16px;
        }

        .certificate-title {
            margin: 15px 0 0 0;
            color: #e74c3c;
            font-size: 24px;
            font-weight: bold;
        }

        .certificate-body {
            line-height: 1.8;
            font-size: 16px;
            color: #2c3e50;
        }

        .certificate-section {
            margin-bottom: 25px;
        }

        .certificate-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .certificate-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .certificate-table th,
        .certificate-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }

        .certificate-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: center;
        }

        .certificate-table td:last-child {
            text-align: right;
        }

        .certificate-footer {
            margin-top: 40px;
            text-align: right;
        }

        .signature-line {
            border-top: 2px solid #2c3e50;
            width: 200px;
            margin: 0 0 5px auto;
        }

        .signature-text {
            margin: 0;
            font-weight: bold;
            font-size: 16px;
        }

        .signature-title {
            margin: 0;
            font-size: 14px;
            color: #7f8c8d;
        }

        .grade-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin: 20px 0;
        }

        .grade-display h2 {
            margin: 0;
            font-size: 36px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .subject-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        .subject-name {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
            text-transform: capitalize;
        }

        .subject-marks {
            font-size: 24px;
            color: #007bff;
            font-weight: bold;
        }

        .attendance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }

        @media print {
            .modal-content {
                box-shadow: none;
                margin: 0;
                max-width: none;
                width: 100%;
            }
            
            button {
                display: none;
            }
            
            .certificate-container {
                border: 2px solid #000;
                page-break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .header-buttons {
                justify-content: center;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
            }

            .certificate-container {
                padding: 20px;
            }

            .school-name {
                font-size: 24px;
            }

            .certificate-title {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <script>
        // Reusable Notification System
        const notificationCSS = `
<style>
.notification-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease-out;
}

.notification-modal {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 0;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow: auto;
    box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
    animation: slideInUp 0.4s ease-out;
    position: relative;
}

.notification-header {
    background: rgba(255, 255, 255, 0.15);
    padding: 25px;
    text-align: center;
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    color: white;
}

.notification-icon {
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    margin: 0 auto 15px;
    animation: pulse 2s infinite;
}

.notification-title {
    font-size: 24px;
    font-weight: bold;
    margin: 0 0 10px 0;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.notification-subtitle {
    font-size: 16px;
    opacity: 0.9;
    margin: 0;
}

.notification-body {
    padding: 30px;
    background: white;
    color: #333;
}

.notification-content {
    margin-bottom: 20px;
}

.notification-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 25px;
}

.notification-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 25px;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.notification-primary-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.notification-primary-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
}

.notification-secondary-btn {
    background: transparent;
    color: #667eea;
    border: 2px solid #667eea;
}

.notification-secondary-btn:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
}

.notification-close-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.notification-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideInUp {
    from { 
        opacity: 0;
        transform: translateY(50px) scale(0.9);
    }
    to { 
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
</style>
`;

document.head.insertAdjacentHTML('beforeend', notificationCSS);

function showNotificationModal(title, subtitle, icon, content, onClose = null, autoClose = 30000) {
    const overlayId = 'notificationOverlay_' + Date.now();
    const notificationHTML = `
        <div class="notification-overlay" id="${overlayId}">
            <div class="notification-modal">
                <button class="notification-close-btn" onclick="closeNotificationModal('${overlayId}')">&times;</button>
                
                <div class="notification-header">
                    <div class="notification-icon">${icon}</div>
                    <h3 class="notification-title">${title}</h3>
                    <p class="notification-subtitle">${subtitle}</p>
                </div>
                
                <div class="notification-body">
                    <div class="notification-content">
                        ${content}
                    </div>
                    
                    <div class="notification-actions">
                        <button class="notification-btn notification-secondary-btn" onclick="closeNotificationModal('${overlayId}')">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', notificationHTML);
    
    if (autoClose) {
        setTimeout(() => {
            closeNotificationModal(overlayId);
        }, autoClose);
    }
}

function closeNotificationModal(overlayId) {
    const overlay = document.getElementById(overlayId);
    if (overlay) {
        overlay.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => {
            overlay.remove();
        }, 300);
    }
}
// Show fee due notification
async function showFeeDueNotification(studentCode) {
    try {
        // UPDATED: Use student-specific endpoint that returns only issued certificates
        const response = await fetch(`${window.location.origin}/api/student-fee-certificates/${studentCode}`);
        
        if (!response.ok) {
            return;
        }
        
        const feeCertificates = await response.json();
        
        // UPDATED: Find the latest certificate with due amount from array
        const studentCertificate = feeCertificates.find(cert => 
            cert.remainingDue > 0
        );
        
        if (!studentCertificate) {
            return;
        }
        
        const content = `
            <div style="text-align: center;">
                <p style="font-size: 18px; color: #666; margin: 10px 0;">Amount Due</p>
                <p style="font-size: 36px; font-weight: bold; color: #dc3545; margin: 20px 0;">‚Çπ${studentCertificate.remainingDue.toFixed(2)}</p>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0;">
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                        <div style="font-weight: bold;">‚Çπ${studentCertificate.totalFee.toFixed(2)}</div>
                        <div style="font-size: 12px; color: #666;">Total Fee</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                        <div style="font-weight: bold;">‚Çπ${studentCertificate.amountPaid.toFixed(2)}</div>
                        <div style="font-size: 12px; color: #666;">Paid</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                        <div style="font-weight: bold;">${studentCertificate.academicYear}</div>
                        <div style="font-size: 12px; color: #666;">Academic Year</div>
                    </div>
                </div>
                <p style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-top: 20px; font-size: 14px; color: #856404;">
                    <strong>Reminder:</strong> Please clear your outstanding fees at the earliest.
                </p>
            </div>
        `;
        
        showNotificationModal('Fee Payment Reminder', 'Outstanding Amount Due', 'üí≥', content, null, 30000);
        
    } catch (error) {
        console.error('Error loading fee notification:', error);
    }
}

function initializeFeeNotification() {
    const studentCode = sessionStorage.getItem('studentCode');
    if (studentCode) {
        setTimeout(() => {
            showFeeDueNotification(studentCode);
        }, 2000);
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeFeeNotification);
} else {
    initializeFeeNotification();
}
    </script>

    <div class="container">
        <div class="header">
            <div class="student-profile">
                <div class="avatar" id="studentAvatar">S</div>
                <div class="profile-info">
                    <h1>Student Dashboard</h1>
                    <div id="studentInfo"></div>
                </div>
            </div>
            <div class="header-buttons">
                <button onclick="openProfileModal()" class="info-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">Manage Profile</button>
                <button onclick="showHallTicketSection()" class="primary-btn" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none;">üé´ Hall Tickets</button>
                <button onclick="showFeeCertificate()" class="fee-btn">Fee Certificate</button>
                <button onclick="window.location.href='index.html'" class="danger-btn">Logout</button>
            </div>
        </div>

        <!-- Enhanced Profile Management Modal -->
        <div id="profileModal" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px);">
            <div class="modal-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 2% auto; padding: 0; border-radius: 20px; width: 90%; max-width: 600px; box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3); overflow: hidden;">
                <div class="profile-modal-header" style="background: rgba(255, 255, 255, 0.15); padding: 25px; text-align: center; color: white; border-bottom: 2px solid rgba(255, 255, 255, 0.2); position: relative;">
                    <button onclick="closeProfileModal()" style="position: absolute; top: 15px; right: 20px; background: rgba(255, 255, 255, 0.2); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">&times;</button>
                    <h2 style="margin: 0 0 10px 0; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);">Manage Your Profile</h2>
                    <p style="margin: 0; font-size: 16px; opacity: 0.9;">Update your personal information and profile picture</p>
                </div>
                
                <div class="profile-modal-body" style="padding: 30px; background: white; color: #333; max-height: 70vh; overflow-y: auto;">
                    <!-- Profile Picture Section -->
                    <div class="profile-picture-section" style="text-align: center; margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 15px; border: 2px dashed #dee2e6;">
                        <div class="current-avatar" style="margin-bottom: 20px;">
                            <div id="profilePreview" style="width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 15px; background: #007bff; color: white; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold; border: 4px solid white; box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3); background-size: cover; background-position: center;">S</div>
                            <h4 style="margin: 0 0 15px 0; color: #495057;">Current Profile Picture</h4>
                        </div>
                        
                        <div class="upload-section">
                            <input type="file" id="profilePictureInput" accept="image/*" style="display: none;" onchange="handleProfilePictureUpload(this)">
                            <label for="profilePictureInput" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; display: inline-block; margin-right: 10px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                                Upload New Picture
                            </label>
                            <button onclick="removeProfilePicture()" style="background: #dc3545; color: white; padding: 12px 25px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);">
                                Remove Picture
                            </button>
                            <p style="margin: 15px 0 0 0; font-size: 12px; color: #6c757d;">Recommended: Square image, max 2MB, JPG/PNG format</p>
                        </div>
                    </div>

                    <!-- Profile Information Form -->
                    <form id="profileForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group" style="display: flex; flex-direction: column;">
                            <label style="font-weight: bold; margin-bottom: 8px; color: #495057; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Full Name</label>
                            <input type="text" id="fullName" style="padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; transition: all 0.3s ease; background: #f8f9fa;" placeholder="Enter your full name">
                        </div>
                        
                        <div class="form-group" style="display: flex; flex-direction: column;">
                            <label style="font-weight: bold; margin-bottom: 8px; color: #495057; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Father's Name</label>
                            <input type="text" id="fatherName" style="padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; transition: all 0.3s ease; background: #f8f9fa;" placeholder="Enter father's name">
                        </div>
                        
                        <div class="form-group" style="display: flex; flex-direction: column;">
                            <label style="font-weight: bold; margin-bottom: 8px; color: #495057; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Date of Birth</label>
                            <input type="date" id="dateOfBirth" style="padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; transition: all 0.3s ease; background: #f8f9fa;">
                        </div>
                        
                        <div class="form-group" style="display: flex; flex-direction: column;">
                            <label style="font-weight: bold; margin-bottom: 8px; color: #495057; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Location</label>
                            <input type="text" id="location" style="padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; transition: all 0.3s ease; background: #f8f9fa;" placeholder="Enter your location">
                        </div>
                        
                        <div class="form-group" style="display: flex; flex-direction: column;">
                            <label style="font-weight: bold; margin-bottom: 8px; color: #495057; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Student Code</label>
                            <input type="text" id="studentCodeDisplay" style="padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; background: #e9ecef; color: #6c757d;" readonly>
                        </div>
                        
                        <div class="form-group" style="display: flex; flex-direction: column;">
                            <label style="font-weight: bold; margin-bottom: 8px; color: #495057; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Class & Roll</label>
                            <input type="text" id="classRollDisplay" style="padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; background: #e9ecef; color: #6c757d;" readonly>
                        </div>
                    </form>

                    <div class="profile-actions" style="display: flex; gap: 15px; justify-content: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                        <button onclick="saveProfile()" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 12px 30px; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); text-transform: uppercase; letter-spacing: 0.5px;">
                            Save Changes
                        </button>
                        <button onclick="closeProfileModal()" style="background: #6c757d; color: white; padding: 12px 30px; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button onclick="loadData()" class="success-btn">Refresh All Data</button>
        </div>

        <!-- Hall Tickets Section -->
        <div class="section" id="hallTicketsSection" style="display: none;">
            <h2>üé´ My Hall Tickets</h2>
            <button class="primary-btn" onclick="loadMyHallTickets()">View My Hall Tickets</button>
            <div id="myHallTickets">
                <div class="loading">Click to load your hall tickets...</div>
            </div>
            <button onclick="hideHallTicketSection()" style="background: rgba(100, 116, 139, 0.1); color: #64748b; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 1rem;">
                ‚úï Close Hall Tickets
            </button>
        </div>

        <!-- Fee Certificate Section -->
        <div class="section" id="feeCertificateSection" style="display: none;">
            <h2>Fee Certificate</h2>
            <button class="primary-btn" onclick="loadFeeCertificate()">View My Fee Certificate</button>
            <div id="feeCertificateContent">
                <div class="loading">Click to load your fee certificate...</div>
            </div>
        </div>

        <!-- Notification Section -->
        <div class="section" id="notificationsSection" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 0; overflow: hidden; margin-bottom: 2rem; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
            <div style="padding: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="color: white; margin: 0; font-size: 24px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 32px;">üì¢</span>
                        Admin Notifications
                    </h2>
                    <button onclick="refreshNotifications()" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        üîÑ Refresh
                    </button>
                </div>
                
                <div id="notificationsDisplay" style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.8); font-size: 16px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                        <p style="margin: 0;">Loading notifications...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Section -->
        <div class="section">
            <h2>My Attendance</h2>
            <button class="primary-btn" onclick="loadMyAttendance()">View My Attendance</button>
            <div id="myAttendance">
                <div class="loading">Click to load your attendance records...</div>
            </div>
        </div>

        <!-- Digital Progress Card Section -->
        <div class="section">
            <h2>My Digital Progress Card</h2>
            <button class="primary-btn" onclick="loadMyProgressCard()">View My Progress Card</button>
            <div id="myProgressCard">
                <div class="loading">Click to load your progress card...</div>
            </div>
        </div>

        <!-- Assignments Section -->
        <div class="section">
            <h2>Available MCQ Assignments</h2>
            <button class="warning-btn" onclick="loadAssignments()">Load Assignments</button>
            <button onclick="viewMyResults()" class="success-btn">View My Results</button>
            <div id="assignmentsList">
                <div class="loading">Loading assignments...</div>
            </div>
        </div>

        <!-- Faculty Posts Section -->
        <div class="section">
            <h2>Faculty Posts for Your Class</h2>
            <div id="facultyPosts">
                <div class="loading">Loading faculty posts...</div>
            </div>
        </div>
    </div>

    <!-- Assignment Taking Modal -->
    <div id="assignmentModal" class="modal">
        <div class="modal-content modal-fixed">
            <div id="timerDisplay" class="timer" style="display: none;"></div>
            <div id="assignmentContent"></div>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="modal">
        <div class="modal-content modal-fixed">
            <h3>Assignment Results</h3>
            <div id="resultsContent"></div>
            <button onclick="closeResults()" class="danger-btn">Close</button>
        </div>
    </div>

    <!-- My Results Modal -->
    <div id="myResultsModal" class="modal">
        <div class="modal-content modal-fixed">
            <h3>My Assignment Results</h3>
            <div id="myResultsContent"></div>
            <button onclick="closeMyResults()" class="danger-btn">Close</button>
        </div>
    </div>

    <!-- Progress Card Detail Modal -->
    <div id="progressDetailModal" class="modal">
        <div class="modal-content modal-fixed">
            <h3>My Progress Card Certificate</h3>
            <div id="progressDetailContent"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="printProgressCard()" class="success-btn">Print Certificate</button>
                <button onclick="closeProgressDetail()" class="danger-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Attendance Detail Modal -->
    <div id="attendanceDetailModal" class="modal">
        <div class="modal-content modal-fixed">
            <h3>My Attendance Certificate</h3>
            <div id="attendanceDetailContent"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="printAttendanceCertificate()" class="success-btn">Print Certificate</button>
                <button onclick="closeAttendanceDetail()" class="danger-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Fee Certificate Modal -->
    <div id="feeCertificateModal" class="modal">
        <div class="modal-content modal-fixed" style="max-width: 800px;">
            <div id="feeCertificateDisplay"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="printFeeCertificate()" class="success-btn">Print Certificate</button>
                <button onclick="closeFeeCertificateModal()" class="danger-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Hall Ticket Detail Modal -->
    <div id="hallTicketDetailModal" class="modal">
        <div class="modal-content modal-fixed" style="max-width: 900px;">
            <div id="hallTicketDetailContent"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="printHallTicket()" class="success-btn">Print Hall Ticket</button>
                <button onclick="closeHallTicketDetail()" class="danger-btn">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let studentCode = '';
        let studentClass = '';
        let studentRoll = '';
        let studentName = '';
        let currentAssignment = null;
        let startTime = null;
        let timerInterval = null;
        let notifications = [];
        let lastCheckedTime = Date.now();
        let notificationCheckInterval;

        const API_BASE = `${window.location.origin}/api`;

        // ===== NOTIFICATION SYSTEM =====
        
        // Initialize notification system
        function initializeNotificationSystem() {
            if (!studentCode) {
                console.error('Cannot initialize notifications: studentCode not set');
                return;
            }

            console.log('‚úÖ Initializing notification system for:', studentCode);

            if (notificationCheckInterval) {
                clearInterval(notificationCheckInterval);
            }

            notificationCheckInterval = setInterval(checkForNewNotifications, 30000);
            checkForNewNotifications();
        }

        // Check for new notifications
        async function checkForNewNotifications() {
            try {
                if (!studentCode) {
                    console.error('‚ùå studentCode not available');
                    return;
                }

                const response = await fetch(`${API_BASE}/student/notifications/${studentCode}`);
                if (!response.ok) {
                    console.error('‚ùå API response not OK:', response.status);
                    return;
                }
                
                const apiNotifications = await response.json();
                console.log('üì© Received notifications from API:', apiNotifications.length);
                
                const newNotifications = apiNotifications.filter(apiNotif => 
                    !apiNotif.isRead && !notifications.some(n => n.id === apiNotif.id)
                );

                if (newNotifications.length > 0) {
                    console.log('üîî Found new notifications:', newNotifications.length);
                    
                    if (newNotifications.length >= 2) {
                        showGroupedNotificationToast(newNotifications);
                    } else {
                        newNotifications.forEach(notif => {
                            showNotificationToast(notif);
                        });
                    }
                }

                notifications = apiNotifications;
                displayNotifications();
            } catch (error) {
                console.error('‚ùå Error checking notifications:', error);
            }
        }

        // Display notifications in the main section
        function displayNotifications() {
            const container = document.getElementById('notificationsDisplay');
            
            if (!notifications || notifications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.8); font-size: 16px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                        <p style="margin: 0;">No notifications available</p>
                    </div>
                `;
                return;
            }

            let html = '';
            notifications.forEach(notif => {
                const isUnread = !notif.isRead;
                const createdDate = new Date(notif.createdAt).toLocaleString('en-IN');
                const expiryDate = notif.expiryDate ? new Date(notif.expiryDate).toLocaleString('en-IN') : 'No expiry';
                
                const typeIcons = {
                    general: 'üìå',
                    urgent: 'üö®',
                    info: '‚ÑπÔ∏è',
                    event: 'üìÖ',
                    holiday: 'üèñÔ∏è',
                    exam: 'üìù'
                };
                
                const priorityColors = {
                    low: 'rgba(16, 185, 129, 0.2)',
                    normal: 'rgba(251, 191, 36, 0.2)',
                    high: 'rgba(249, 115, 22, 0.2)',
                    urgent: 'rgba(239, 68, 68, 0.2)'
                };
                
                const icon = typeIcons[notif.type] || 'üì¢';
                const bgColor = isUnread ? 'rgba(255, 255, 255, 0.95)' : 'rgba(255, 255, 255, 0.7)';
                const borderColor = isUnread ? '#fbbf24' : 'rgba(255, 255, 255, 0.3)';
                
                html += `
                    <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s; position: relative; ${isUnread ? 'border-left: 5px solid #fbbf24;' : ''}" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.1)'">
                        ${isUnread ? '<div style="position: absolute; top: 10px; right: 10px; width: 12px; height: 12px; background: #fbbf24; border-radius: 50%; animation: pulse 2s infinite;"></div>' : ''}
                        
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <span style="font-size: 24px;">${icon}</span>
                                    <h4 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: 700;">${notif.title}</h4>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                                    <span style="background: ${priorityColors[notif.priority] || 'rgba(156, 163, 175, 0.2)'}; color: #1f2937; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${notif.priority}</span>
                                    <span style="background: rgba(59, 130, 246, 0.2); color: #1f2937; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">${notif.type}</span>
                                </div>
                            </div>
                        </div>
                        
                        <p style="margin: 0 0 15px 0; color: #4b5563; line-height: 1.6; font-size: 14px;">${notif.message}</p>
                        
                        ${notif.file ? `
                            <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                                <span style="color: #6b7280; font-size: 12px; font-weight: 600;">üìé Attachment: </span>
                                <a href="${notif.file}" target="_blank" style="color: #3b82f6; text-decoration: none; font-weight: 600; font-size: 13px;">${notif.fileName || 'View File'}</a>
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #6b7280; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                            <span>üìÖ ${createdDate}</span>
                            <span>‚è∞ Expires: ${expiryDate}</span>
                        </div>
                        
                        ${isUnread ? `
                            <div style="margin-top: 15px;">
                                <button onclick="markAsRead('${notif.id}')" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; width: 100%; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                    ‚úì Mark as Read
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Show notification toast
        function showNotificationToast(notif) {
            const container = document.getElementById('notificationToastContainer') || createToastContainer();
            const toast = document.createElement('div');
            
            const icon = notif.type === 'urgent' ? 'üö®' : notif.type === 'exam' ? 'üìù' : 'üì¢';
            
            toast.style.cssText = `
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 15px 20px;
                border-radius: 12px;
                box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
                min-width: 300px;
                max-width: 400px;
                animation: slideInDown 0.5s ease;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <strong style="font-size: 14px;">${icon} ${notif.title}</strong>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1;">√ó</button>
                </div>
                <p style="margin: 0; font-size: 13px; line-height: 1.4; opacity: 0.95;">${notif.message.substring(0, 80)}${notif.message.length > 80 ? '...' : ''}</p>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideOutUp 0.5s ease';
                    setTimeout(() => toast.remove(), 500);
                }
            }, 5000);
        }

        // Show grouped notification toast
        function showGroupedNotificationToast(notifs) {
            const container = document.getElementById('notificationToastContainer') || createToastContainer();
            const toast = document.createElement('div');
            
            toast.style.cssText = `
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 15px 20px;
                border-radius: 12px;
                box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
                min-width: 300px;
                max-width: 400px;
                animation: slideInDown 0.5s ease;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <strong style="font-size: 14px;">üîî ${notifs.length} New Notifications</strong>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1;">√ó</button>
                </div>
                <p style="margin: 0; font-size: 13px; line-height: 1.4; opacity: 0.95;">You have ${notifs.length} new notifications from admin. Check them out!</p>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideOutUp 0.5s ease';
                    setTimeout(() => toast.remove(), 500);
                }
            }, 5000);
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'notificationToastContainer';
            container.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px;';
            document.body.appendChild(container);
            return container;
        }

        // Mark notification as read
        async function markAsRead(notificationId) {
            try {
                const response = await fetch(`${API_BASE}/notifications/${notificationId}/read`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userCode: studentCode
                    })
                });

                if (response.ok) {
                    const notif = notifications.find(n => n.id === notificationId);
                    if (notif) {
                        notif.isRead = true;
                    }
                    displayNotifications();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Refresh notifications
        async function refreshNotifications() {
            await checkForNewNotifications();
            alert('Notifications refreshed!');
        }

        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInDown {
                from {
                    transform: translateY(-100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutUp {
                from {
                    transform: translateY(0);
                    opacity: 1;
                }
                to {
                    transform: translateY(-100%);
                    opacity: 0;
                }
            }
            
            @keyframes pulse {
                0%, 100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }
        `;
        document.head.appendChild(style);

        // Profile Management Functions
        function openProfileModal() {
            loadProfileData();
            document.getElementById('profileModal').style.display = 'block';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function loadProfileData() {
             const profileData = JSON.parse(localStorage.getItem(`profile_${studentCode}`) || '{}');
    
    document.getElementById('fullName').value = profileData.fullName || studentName || '';
    document.getElementById('fatherName').value = profileData.fatherName || '';
    document.getElementById('dateOfBirth').value = profileData.dateOfBirth || '';
    document.getElementById('location').value = profileData.location || '';
    document.getElementById('studentCodeDisplay').value = studentCode;
    document.getElementById('classRollDisplay').value = `Class: ${studentClass.toUpperCase()}, Roll: ${studentRoll}`;
    
    const profilePicture = localStorage.getItem(`profilePic_${studentCode}`);
    const preview = document.getElementById('profilePreview');
    if (profilePicture) {
        preview.style.backgroundImage = `url(${profilePicture})`;
        preview.style.backgroundSize = 'cover';  // ADD THIS
        preview.style.backgroundPosition = 'center';  // ADD THIS
        preview.textContent = '';
        preview.style.backgroundColor = 'transparent';
    } else {
        preview.style.backgroundImage = 'none';
        preview.style.backgroundSize = '';  // RESET
        preview.style.backgroundPosition = '';  // RESET
        preview.style.backgroundColor = '#007bff';
        preview.textContent = (profileData.fullName || studentName || 'S').charAt(0).toUpperCase();
    }
        }

        function handleProfilePictureUpload(input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file (JPG, PNG, GIF)');
                input.value = '';
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                alert('File size must be less than 2MB');
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                localStorage.setItem(`profilePic_${studentCode}`, imageData);
                
                const preview = document.getElementById('profilePreview');
                preview.style.backgroundImage = `url(${imageData})`;
                preview.style.backgroundSize = 'cover';  // ADD THIS
                preview.style.backgroundPosition = 'center'; 
                preview.style.backgroundColor = 'transparent';
                preview.textContent = '';
                
                updateMainAvatar();
            };
            reader.readAsDataURL(file);
        }

        function removeProfilePicture() {
            if (confirm('Are you sure you want to remove your profile picture?')) {
                localStorage.removeItem(`profilePic_${studentCode}`);
                
                const preview = document.getElementById('profilePreview');
                preview.style.backgroundImage = 'none';
                preview.style.backgroundSize = '';  // RESET
                preview.style.backgroundPosition = '';  // RESET
                preview.style.backgroundColor = '#007bff';
                preview.textContent = (document.getElementById('fullName').value || studentName || 'S').charAt(0).toUpperCase();
                
                updateMainAvatar();
            }
        }

        function saveProfile() {
            const fullName = document.getElementById('fullName').value.trim();
            const fatherName = document.getElementById('fatherName').value.trim();
            const dateOfBirth = document.getElementById('dateOfBirth').value;
            const location = document.getElementById('location').value.trim();

            if (!fullName) {
                alert('Please enter your full name');
                return;
            }

            const profileData = {
                fullName: fullName,
                fatherName: fatherName,
                dateOfBirth: dateOfBirth,
                location: location,
                lastUpdated: new Date().toISOString()
            };

            localStorage.setItem(`profile_${studentCode}`, JSON.stringify(profileData));
            
            studentName = fullName;
            sessionStorage.setItem('userName', studentName);
            
            updateStudentDisplay();
            updateMainAvatar();
            
            closeProfileModal();
            showNotificationModal('Success', 'Profile Updated', '‚úì', 'Your profile has been updated successfully!', null, 3000);
        }

        function updateMainAvatar() {
            const avatar = document.getElementById('studentAvatar');
            const profilePicture = localStorage.getItem(`profilePic_${studentCode}`);
    
    if (profilePicture) {
        avatar.style.backgroundImage = `url(${profilePicture})`;
        avatar.style.backgroundSize = 'cover';  // ADD THIS
        avatar.style.backgroundPosition = 'center';  // ADD THIS
        avatar.style.backgroundColor = 'transparent';
        avatar.textContent = '';
    } else {
        avatar.style.backgroundImage = 'none';
        avatar.style.backgroundSize = '';  // RESET
        avatar.style.backgroundPosition = '';  // RESET
        avatar.style.backgroundColor = '#667eea';
        avatar.textContent = (studentName || 'S').charAt(0).toUpperCase();
    }
        }

        // Parse CB25 student code format
        function parseStudentCode(code) {
            if (!code) return null;
            
            const nurseryMatch = code.match(/^CB25N(\d{3})$/i);
            if (nurseryMatch) {
                return {
                    classCode: 'nursery',
                    rollNumber: parseInt(nurseryMatch[1]).toString(),
                    fullCode: code.toUpperCase(),
                    type: 'nursery'
                };
            }
            
            const lkgMatch = code.match(/^CB25L(\d{3})$/i);
            if (lkgMatch) {
                return {
                    classCode: 'lkg',
                    rollNumber: parseInt(lkgMatch[1]).toString(),
                    fullCode: code.toUpperCase(),
                    type: 'lkg'
                };
            }
            
            const ukgMatch = code.match(/^CB25U(\d{3})$/i);
            if (ukgMatch) {
                return {
                    classCode: 'ukg',
                    rollNumber: parseInt(ukgMatch[1]).toString(),
                    fullCode: code.toUpperCase(),
                    type: 'ukg'
                };
            }
            
            const classMatch = code.match(/^CB25-(0[1-9]|10)-([1-9]|[1-5][0-9]|60)$/i);
            if (classMatch) {
                return {
                    classCode: parseInt(classMatch[1]).toString(),
                    rollNumber: classMatch[2],
                    fullCode: code.toUpperCase(),
                    type: 'class'
                };
            }
            
            return null;
        }

        // Student initialization
        function initializeStudent() {
            studentCode = sessionStorage.getItem('studentCode') || '';
            studentName = sessionStorage.getItem('userName') || '';
            
            if (!studentCode) {
                alert('Please login first');
                window.location.href = 'index.html';
                return false;
            }
            
            const parsed = parseStudentCode(studentCode);
            if (!parsed) {
                alert('Invalid student code format. Expected CB25 format (e.g., CB25N001, CB25L001, CB25U001, CB25-01-1)');
                window.location.href = 'index.html';
                return false;
            }
            
            studentClass = parsed.classCode;
            studentRoll = parsed.rollNumber;
            
            const profileData = JSON.parse(localStorage.getItem(`profile_${studentCode}`) || '{}');
            if (profileData.fullName) {
                studentName = profileData.fullName;
                sessionStorage.setItem('userName', studentName);
            }
            
            updateStudentDisplay();
            updateMainAvatar();
            
            return true;
        }

        function updateStudentDisplay() {
            const profileData = JSON.parse(localStorage.getItem(`profile_${studentCode}`) || '{}');
            
            let displayContent = `<h3>Welcome Student - Class ${studentClass.toUpperCase()}, Roll No: ${studentRoll}</h3>`;
            
            if (studentName) {
                displayContent += `<p><strong>Name:</strong> ${studentName}</p>`;
            }
            
            if (profileData.fatherName) {
                displayContent += `<p><strong>Father's Name:</strong> ${profileData.fatherName}</p>`;
            }
            
            if (profileData.dateOfBirth) {
                const birthDate = new Date(profileData.dateOfBirth);
                displayContent += `<p><strong>Date of Birth:</strong> ${birthDate.toLocaleDateString('en-IN')}</p>`;
            }
            
            if (profileData.location) {
                displayContent += `<p><strong>Location:</strong> ${profileData.location}</p>`;
            }
            
            displayContent += `<p><strong>Student Code:</strong> ${studentCode}</p>`;
            
            document.getElementById('studentInfo').innerHTML = displayContent;
        }

        // Hall Tickets Functions
        function showHallTicketSection() {
            const section = document.getElementById('hallTicketsSection');
            if (section) {
                section.style.display = 'block';
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function hideHallTicketSection() {
            const section = document.getElementById('hallTicketsSection');
            if (section) {
                section.style.display = 'none';
            }
        }
async function loadMyHallTickets() {
    try {
        const response = await fetch(`${API_BASE}/student-hall-tickets/${studentCode}`);
        
        if (!response.ok) {
            if (response.status === 404) {
                document.getElementById('myHallTickets').innerHTML = '<div class="no-hall-tickets" style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px;">No hall tickets issued yet.</div>';
                return;
            }
            throw new Error(`HTTP ${response.status}`);
        }
        
        const hallTickets = await response.json();
        
        let html = '';
        if (hallTickets.length > 0) {
            hallTickets.forEach(ticket => {
                const fromDate = new Date(ticket.fromDate).toLocaleDateString('en-IN');
                const toDate = new Date(ticket.toDate).toLocaleDateString('en-IN');
                const issuedDate = ticket.issuedDate ? new Date(ticket.issuedDate).toLocaleDateString('en-IN') : 'N/A';
                
                // Format class display
                let classDisplay = ticket.studentClass;
                if (ticket.studentClass === 'nursery') classDisplay = 'Nursery';
                else if (ticket.studentClass === 'lkg') classDisplay = 'LKG';
                else if (ticket.studentClass === 'ukg') classDisplay = 'UKG';
                else classDisplay = 'Class ' + ticket.studentClass;
                
                html += `
                    <div class="hall-ticket-item" style="margin: 15px 0; padding: 20px; border: 2px solid #8b5cf6; border-radius: 12px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); box-shadow: 0 4px 6px rgba(139, 92, 246, 0.1); cursor: pointer; transition: all 0.3s;" 
                         onclick="showHallTicketDetail('${ticket.hallTicketId}')"
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(139, 92, 246, 0.2)'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(139, 92, 246, 0.1)'">
                        
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 10px 0; color: #8b5cf6; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                                    üé´ ${ticket.examName}
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                                    <div>
                                        <span style="color: #6b7280; font-size: 13px; font-weight: 600;">Student Name:</span><br>
                                        <span style="color: #1f2937; font-weight: 600;">${ticket.studentName}</span>
                                    </div>
                                    <div>
                                        <span style="color: #6b7280; font-size: 13px; font-weight: 600;">Class:</span><br>
                                        <span style="color: #1f2937; font-weight: 600;">${classDisplay}</span>
                                    </div>
                                    <div>
                                        <span style="color: #6b7280; font-size: 13px; font-weight: 600;">Roll Number:</span><br>
                                        <span style="color: #1f2937; font-weight: 600;">${ticket.studentRoll}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 12px; border-radius: 8px; margin-top: 15px; border: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <span style="color: #6b7280; font-size: 12px;">üìÖ Exam Period:</span><br>
                                    <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${fromDate} to ${toDate}</span>
                                </div>
                                <div>
                                    <span style="color: #6b7280; font-size: 12px;">üìå Issued Date:</span><br>
                                    <span style="color: #1f2937; font-weight: 600; font-size: 14px;">${issuedDate}</span>
                                </div>
                                <div>
                                    <span style="background: ${ticket.status === 'issued' ? '#10b981' : '#f59e0b'}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                        ${ticket.status === 'issued' ? '‚úì Issued' : '‚è≥ Pending'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; text-align: center; padding-top: 12px; border-top: 1px dashed #cbd5e1;">
                            <span style="color: #8b5cf6; font-size: 13px; font-weight: 600;">
                                üëÜ Click to view and download hall ticket
                            </span>
                        </div>
                    </div>
                `;
            });
        } else {
            html = '<div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px;">No hall tickets issued yet.</div>';
        }
        
        document.getElementById('myHallTickets').innerHTML = html;
    } catch (error) {
        console.error('Error loading hall tickets:', error);
        document.getElementById('myHallTickets').innerHTML = '<div class="error" style="color: #dc3545; text-align: center; padding: 20px;">Error loading hall tickets: ' + error.message + '</div>';
    }
}


async function showHallTicketDetail(hallTicketId) {
    try {
        const response = await fetch(`${API_BASE}/student-hall-tickets/${studentCode}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const hallTickets = await response.json();
        const ticket = hallTickets.find(t => t.hallTicketId === hallTicketId);
        
        if (!ticket) {
            alert('Hall ticket not found');
            return;
        }

        const currentDate = new Date().toLocaleDateString('en-IN');
        const fromDate = new Date(ticket.fromDate).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        const toDate = new Date(ticket.toDate).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });

        // Build exam schedule table with timing
        let examScheduleHTML = '';
        if (ticket.examSchedule && Array.isArray(ticket.examSchedule) && ticket.examSchedule.length > 0) {
            examScheduleHTML += `<table style="width: 100%; border-collapse: collapse; margin-top: 10px; border: 1px solid #000;">`;
            examScheduleHTML += `<thead><tr>`;
            examScheduleHTML += `<th style="border: 1px solid #000; padding: 8px; background-color: #e5e7eb; font-weight: bold; font-size: 13px;">Subject</th>`;
            examScheduleHTML += `<th style="border: 1px solid #000; padding: 8px; background-color: #e5e7eb; font-weight: bold; font-size: 13px;">Date</th>`;
            examScheduleHTML += `<th style="border: 1px solid #000; padding: 8px; background-color: #e5e7eb; font-weight: bold; font-size: 13px;">Day</th>`;
            examScheduleHTML += `<th style="border: 1px solid #000; padding: 8px; background-color: #e5e7eb; font-weight: bold; font-size: 13px;">Timing</th>`;
            examScheduleHTML += `</tr></thead><tbody>`;
            
            ticket.examSchedule.forEach(schedule => {
                if (schedule.date && schedule.exams && Array.isArray(schedule.exams)) {
                    const scheduleDate = new Date(schedule.date);
                    const formattedDate = scheduleDate.toLocaleDateString('en-IN', { 
                        day: '2-digit', 
                        month: 'short', 
                        year: 'numeric' 
                    });
                    const dayName = scheduleDate.toLocaleDateString('en-IN', { weekday: 'long' });
                    
                    schedule.exams.forEach(exam => {
                        examScheduleHTML += `<tr>`;
                        examScheduleHTML += `<td style="border: 1px solid #000; padding: 8px; font-size: 13px;">${exam.examName || 'N/A'}</td>`;
                        examScheduleHTML += `<td style="border: 1px solid #000; padding: 8px; font-size: 13px;">${formattedDate}</td>`;
                        examScheduleHTML += `<td style="border: 1px solid #000; padding: 8px; font-size: 13px;">${dayName}</td>`;
                        examScheduleHTML += `<td style="border: 1px solid #000; padding: 8px; font-size: 13px;">${exam.timing || 'N/A'}</td>`;
                        examScheduleHTML += `</tr>`;
                    });
                }
            });
            
            examScheduleHTML += `</tbody></table>`;
        }

        // Format class display
        let classDisplay = ticket.studentClass;
        if (ticket.studentClass === 'nursery') classDisplay = 'Nursery';
        else if (ticket.studentClass === 'lkg') classDisplay = 'LKG';
        else if (ticket.studentClass === 'ukg') classDisplay = 'UKG';
        else classDisplay = 'Class ' + ticket.studentClass;

        // Create modal overlay
        const modalOverlay = document.createElement('div');
        modalOverlay.id = 'studentHallTicketPreview';
        modalOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        `;

        const contentWrapper = document.createElement('div');
        contentWrapper.style.cssText = `
            background: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        `;

        const hallTicketDiv = document.createElement('div');
        hallTicketDiv.id = 'studentHallTicketContent';
        hallTicketDiv.style.cssText = 'width: 800px; background: white; padding: 40px; font-family: "Times New Roman", serif;';
        
        hallTicketDiv.innerHTML = `
            <div style="border: 3px solid #1e40af; padding: 30px; background: white;">
                <div style="border-bottom: 2px solid #1e40af; padding-bottom: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                        <img src="logo.png" alt="School Logo" style="width: 80px; height: 80px; object-fit: contain; flex-shrink: 0;" onerror="this.style.display='none'">
                        <div style="flex: 1; text-align: center;">
                            <h1 style="font-size: 24px; font-weight: bold; color: #1e40af !important; margin: 0 0 8px 0; background: transparent;">VISWA BHARATHI HIGH SCHOOL</h1>

                            <p style="font-size: 12px; color: #333; margin: 3px 0;">NEHRU ROAD, PRODDATUR - 516 360. Kadapa Dist. (A.P.)</p>
                            <p style="font-size: 12px; color: #333; margin: 3px 0;">Cell: 6301444214, 8555950709</p>
                        </div>
                    </div>
                    <h2 style="text-align: center; font-size: 20px; color: #000; text-decoration: underline; margin: 15px 0 0 0;">HALL TICKET (${ticket.examName})</h2>
                </div>
                
                <div style="margin: 20px 0;">
                    <div style="margin: 12px 0;">
                        <span style="font-weight: bold; color: #000; font-size: 14px;">Student Name: </span>
                        <span style="color: #333; font-size: 14px;">${ticket.studentName}</span>
                    </div>
                    
                    <div style="margin: 12px 0;">
                        <span style="font-weight: bold; color: #000; font-size: 14px;">Class & Sec: </span>
                        <span style="color: #333; font-size: 14px;">${classDisplay}</span>
                    </div>
                    
                    <div style="margin: 12px 0;">
                        <span style="font-weight: bold; color: #000; font-size: 14px;">Roll No: </span>
                        <span style="color: #333; font-size: 14px;">${ticket.studentRoll}</span>
                    </div>
                    
                    ${examScheduleHTML ? `<div style="margin: 15px 0;">${examScheduleHTML}</div>` : ''}
                    
                    ${ticket.remarks ? `
                    <div style="margin: 15px 0; padding: 10px; background: #f9fafb; border: 1px solid #d1d5db; border-radius: 4px;">
                        <p style="font-size: 12px; margin: 0;"><strong>Instructions:</strong> ${ticket.remarks}</p>
                    </div>
                    ` : ''}
                </div>
                
                <div style="margin-top: 40px; text-align: right;">
                    <div style="display: inline-block; text-align: center; min-width: 150px;">
                        <div style="border-top: 2px solid #000; margin-bottom: 5px;"></div>
                        <p style="font-size: 12px; color: #000; margin: 5px 0;">Principal</p>
                        <p style="font-size: 12px; color: #000; margin: 5px 0;"><strong>Viswabharathi School</strong></p>
                    </div>
                </div>
            </div>
        `;

        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = 'margin-top: 20px; text-align: center; display: flex; gap: 10px; justify-content: center;';
        
        const downloadBtn = document.createElement('button');
        downloadBtn.textContent = '‚¨áÔ∏è Download as PNG';
        downloadBtn.style.cssText = 'background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;';
        downloadBtn.onclick = function() {
            generateStudentHallTicketImage(hallTicketDiv, ticket);
        };
        
        const closeBtn = document.createElement('button');
        closeBtn.textContent = '‚úï Close';
        closeBtn.style.cssText = 'background: #ef4444; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;';
        closeBtn.onclick = function() {
            document.body.removeChild(modalOverlay);
        };

        buttonContainer.appendChild(downloadBtn);
        buttonContainer.appendChild(closeBtn);
        
        contentWrapper.appendChild(hallTicketDiv);
        contentWrapper.appendChild(buttonContainer);
        modalOverlay.appendChild(contentWrapper);
        document.body.appendChild(modalOverlay);

    } catch (error) {
        console.error('Error loading hall ticket details:', error);
        alert('Error loading hall ticket details: ' + error.message);
    }
}
// Helper function to generate hall ticket image for students
function generateStudentHallTicketImage(element, ticket) {
    // Check if html2canvas is loaded
    if (typeof html2canvas === 'undefined') {
        showNotification('Image generation library not loaded. Please refresh the page.', 'error');
        // Try to reload the library
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        script.onload = function() {
            showNotification('Library loaded. Please try downloading again.', 'info');
        };
        document.head.appendChild(script);
        return;
    }
    
    const notification = document.createElement('div');
    notification.style.cssText = `position: fixed; top: 20px; right: 20px; z-index: 10001; background: #3b82f6; color: white; padding: 1rem; border-radius: 8px; font-weight: 600;`;
    notification.textContent = 'Converting to image...';
    document.body.appendChild(notification);
    
    html2canvas(element, {
        scale: 2,
        backgroundColor: '#ffffff',
        logging: false,
        useCORS: true,
        allowTaint: true,
        width: element.offsetWidth,
        height: element.offsetHeight
    }).then(function(canvas) {
        console.log('Canvas created successfully:', canvas.width, 'x', canvas.height);
        
        // Convert canvas to blob
        canvas.toBlob(function(blob) {
            if (!blob) {
                document.body.removeChild(notification);
                alert('Failed to create image file');
                return;
            }
            
            // Create download link
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const fileName = `HallTicket_${ticket.studentName.replace(/\s+/g, '_')}_${ticket.studentRoll}.png`;
            link.download = fileName;
            link.href = url;
            link.click();
            
            // Cleanup
            setTimeout(() => {
                URL.revokeObjectURL(url);
            }, 100);
            
            notification.style.background = '#10b981';
            notification.textContent = '‚úÖ Hall ticket downloaded successfully!';
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 2000);
            
            // Close modal after download
            const modal = document.getElementById('studentHallTicketPreview');
            if (modal) {
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 2000);
            }
        }, 'image/png');
        
    }).catch(function(error) {
        console.error('html2canvas error:', error);
        document.body.removeChild(notification);
        alert('Failed to generate image. Error: ' + (error.message || 'Unknown'));
    });
}

        function closeHallTicketDetail() {
            document.getElementById('hallTicketDetailModal').style.display = 'none';
        }

        // Fee Certificate Functions
        function showFeeCertificate() {
            const section = document.getElementById('feeCertificateSection');
            if (section) {
                section.style.display = 'block';
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function loadFeeCertificate() {
    try {
        const response = await fetch(`${API_BASE}/student-fee-certificates/${studentCode}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const feeCertificates = await response.json();
        
        let html = '';
        if (feeCertificates.length > 0) {
            feeCertificates.forEach(cert => {
                // CHANGE 1: Use issuedDate if available, otherwise fall back to date
                const displayDate = cert.issuedDate ? 
                    new Date(cert.issuedDate).toLocaleDateString('en-IN') : 
                    new Date(cert.date).toLocaleDateString('en-IN');
                
                html += `
                    <div class="fee-certificate-preview" onclick="showFeeCertificateDetail('${cert.id}')" 
                         style="cursor: pointer; margin: 10px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; transition: box-shadow 0.2s;"
                         onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" 
                         onmouseout="this.style.boxShadow='none'">
                        <h4 style="margin: 0 0 10px 0; color: #333;">Fee Certificate - ${cert.academicYear}</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                                <strong>Total Fee</strong><br>
                                ‚Çπ${cert.totalFee}
                            </div>
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                                <strong>Paid</strong><br>
                                ‚Çπ${cert.amountPaid}
                            </div>
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                                <strong>Due</strong><br>
                                <span style="color: ${cert.remainingDue > 0 ? '#dc3545' : '#28a745'};">‚Çπ${cert.remainingDue}</span>
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center;">
                            <span style="padding: 5px 15px; border-radius: 15px; font-size: 12px; font-weight: bold; color: white; background: ${cert.remainingDue > 0 ? '#dc3545' : '#28a745'};">
                                ${cert.remainingDue > 0 ? 'Payment Pending' : 'Fully Paid'}
                            </span>
                        </div>
                        <p style="margin: 10px 0 0 0; text-align: center; color: #666;">
                            <small>Issued: ${displayDate} | Click to view full certificate</small>
                        </p>
                    </div>
                `;
            });
        } else {
            // CHANGE 2: Updated message for no certificates
            html = '<div class="no-certificate" style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px; margin: 10px 0;">No fee certificate issued yet. Please contact the school office.</div>';
        }
        
        document.getElementById('feeCertificateContent').innerHTML = html;
    } catch (error) {
        console.error('Error loading fee certificate:', error);
        document.getElementById('feeCertificateContent').innerHTML = '<div class="error" style="color: #dc3545; text-align: center; padding: 20px;">Error loading fee certificate: ' + error.message + '</div>';
    }
}

        async function showFeeCertificateDetail(certificateId) {
            try {
                const response = await fetch(`${API_BASE}/student-fee-certificates/${studentCode}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const certificates = await response.json();
                const certificate = certificates.find(c => c.id == certificateId);
                
                if (!certificate) {
                    alert('Certificate not found');
                    return;
                }

                const currentDate = new Date().toLocaleDateString('en-IN');

                const certificateHTML = `
                    <div id="printableFeeCertificate" class="certificate-container">
                        <div class="certificate-header">
                            <div class="header-flex">
                                <img src="logo.png" alt="School Logo" class="school-logo" onerror="this.style.display='none'">
                                <div class="school-info">
                                    <h1 class="school-name">VISWA BHARATHI HIGH SCHOOL</h1>
                                    <p class="school-address">NEHRU ROAD, PRODDATUR-516 360. Kadapa Dist. (A.P.)</p>
                                    <p class="school-address">Cell: 6301444214, 8555950709</p>
                                </div>
                            </div>
                            <h2 class="certificate-title">FEE CERTIFICATE</h2>
                        </div>
                        <div class="certificate-body">
                            <div class="certificate-section">
                                <p><strong>Certificate No:</strong> FC${certificate.id}</p>
                                <p><strong>Date of Issue:</strong> ${currentDate}</p>
                                <p><strong>Academic Year:</strong> ${certificate.academicYear}</p>
                            </div>
                            <div class="certificate-section">
                                <h3>STUDENT DETAILS</h3>
                                <p><strong>Student Name:</strong> ${certificate.studentName}</p>
                                <p><strong>Student Code:</strong> ${certificate.studentCode}</p>
                                <p><strong>Roll Number:</strong> ${certificate.studentRoll}</p>
                                <p><strong>Father's Name:</strong> ${certificate.fatherName}</p>
                                <p><strong>Class:</strong> ${certificate.studentClass.toUpperCase()}</p>
                            </div>
                            <div class="certificate-section">
                                <h3>FEE DETAILS</h3>
                                <table class="certificate-table">
                                    <tr>
                                        <th>Description</th>
                                        <th>Amount (‚Çπ)</th>
                                    </tr>
                                    <tr>
                                        <td>Total Fee Amount</td>
                                        <td>${certificate.totalFee.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td>Amount Paid</td>
                                        <td>${certificate.amountPaid.toFixed(2)}</td>
                                    </tr>
                                    <tr style="background-color: #f8f9fa; font-weight: bold;">
                                        <td>Remaining Due</td>
                                        <td style="color: ${certificate.remainingDue > 0 ? '#dc3545' : '#28a745'};">${certificate.remainingDue.toFixed(2)}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="certificate-footer">
                                <div class="signature-line"></div>
                                <p class="signature-text">Correspondent</p>
                                <p class="signature-title">Viswabharathi School</p>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('feeCertificateDisplay').innerHTML = certificateHTML;
                document.getElementById('feeCertificateModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading certificate details:', error);
                alert('Error loading certificate details: ' + error.message);
            }
        }

        function printFeeCertificate() {
            const printContents = document.getElementById('printableFeeCertificate').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Fee Certificate - Viswabharathi School</title>
                        <style>
                            body { font-family: 'Times New Roman', serif; margin: 0; padding: 20px; }
                            .certificate-container { border: 2px solid #000; padding: 40px; }
                            .certificate-header { border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
                            .header-flex { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
                            .school-logo { width: 100px; height: 100px; flex-shrink: 0; object-fit: contain; }
                            .school-info { flex: 1; text-align: left; }
                            .school-name { font-size: 28px; font-weight: bold; margin: 0 0 10px 0; color: rgb(52,164,220); }
                            .school-address { margin: 5px 0; font-size: 14px; color: #666; }
                            .certificate-title { font-size: 24px; color: #000; margin: 15px 0 0 0; text-align: center; text-decoration: underline; }
                            .certificate-section { margin-bottom: 25px; }
                            .certificate-section h3 { border-bottom: 1px solid #000; padding-bottom: 5px; }
                            .certificate-table { width: 100%; border-collapse: collapse; }
                            .certificate-table th, .certificate-table td { border: 1px solid #000; padding: 12px; }
                            .certificate-table th { background-color: #f0f0f0; }
                            .certificate-footer { text-align: right; margin-top: 40px; }
                            .signature-line { border-top: 2px solid #000; width: 200px; margin: 0 0 5px auto; }
                            @media print { body { padding: 0; } }
                        </style>
                    </head>
                    <body>
                        ${printContents}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function closeFeeCertificateModal() {
            document.getElementById('feeCertificateModal').style.display = 'none';
        }

        // Attendance Functions
        async function loadMyAttendance() {
            try {
                const response = await fetch(`${API_BASE}/student-data/${studentCode}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const attendanceRecords = data.monthlyAttendance || [];
                
                let html = '';
                if (attendanceRecords.length > 0) {
                    let totalWorkingDays = 0;
                    let totalAttendedDays = 0;
                    
                    attendanceRecords.forEach(record => {
                        totalWorkingDays += record.totalWorkingDays;
                        totalAttendedDays += record.attendedDays;
                    });
                    
                    const overallPercentage = totalWorkingDays > 0 ? Math.round((totalAttendedDays / totalWorkingDays) * 100) : 0;
                    
                    html += `
                        <div class="overall-stats" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                            <h4>Overall Attendance Summary</h4>
                            <p>Total Days: ${totalWorkingDays} | Attended: ${totalAttendedDays} | Percentage: ${overallPercentage}%</p>
                            <button onclick="showAttendanceCertificate()" class="success-btn" style="margin-top: 10px;">View Attendance Certificate</button>
                        </div>
                    `;
                    
                    attendanceRecords.forEach(record => {
                        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                         'July', 'August', 'September', 'October', 'November', 'December'];
                        const monthName = monthNames[record.month - 1];
                        const color = record.percentage >= 75 ? '#28a745' : record.percentage >= 50 ? '#ffc107' : '#dc3545';
                        
                        html += `
                            <div class="attendance-item" style="margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #fff;">
                                <h5>${monthName} ${record.year}</h5>
                                <p>Days Attended: ${record.attendedDays}/${record.totalWorkingDays}</p>
                                <p>Percentage: <span style="color: ${color}; font-weight: bold;">${record.percentage}%</span></p>
                                <small>Posted: ${new Date(record.postedAt).toLocaleDateString()}</small>
                            </div>
                        `;
                    });
                } else {
                    html = '<div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px;">No attendance records found.</div>';
                }
                
                document.getElementById('myAttendance').innerHTML = html;
            } catch (error) {
                console.error('Error loading attendance:', error);
                document.getElementById('myAttendance').innerHTML = '<div class="error" style="color: #dc3545; text-align: center; padding: 20px;">Error loading attendance records: ' + error.message + '</div>';
            }
        }

        async function showAttendanceCertificate() {
            try {
                const response = await fetch(`${API_BASE}/student-data/${studentCode}`);
                
                if (!response.ok) {
                    alert('No attendance records found');
                    return;
                }
                
                const data = await response.json();
                const attendanceRecords = data.monthlyAttendance || [];
                
                if (attendanceRecords.length === 0) {
                    alert('No attendance records found');
                    return;
                }

                let totalWorkingDays = 0;
                let totalAttendedDays = 0;
                
                attendanceRecords.forEach(record => {
                    totalWorkingDays += record.totalWorkingDays;
                    totalAttendedDays += record.attendedDays;
                });
                
                const overallPercentage = totalWorkingDays > 0 ? Math.round((totalAttendedDays / totalWorkingDays) * 100) : 0;
                const currentDate = new Date().toLocaleDateString('en-IN');
                const currentYear = new Date().getFullYear();

                let monthlyBreakdown = '';
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                 'July', 'August', 'September', 'October', 'November', 'December'];
                
                attendanceRecords.sort((a, b) => {
                    const dateA = new Date(a.year, a.month - 1);
                    const dateB = new Date(b.year, b.month - 1);
                    return dateA - dateB;
                }).forEach(record => {
                    const monthName = monthNames[record.month - 1];
                    monthlyBreakdown += `
                        <tr>
                            <td>${monthName} ${record.year}</td>
                            <td style="text-align: center;">${record.totalWorkingDays}</td>
                            <td style="text-align: center;">${record.attendedDays}</td>
                            <td style="text-align: center; color: ${record.percentage >= 75 ? '#28a745' : record.percentage >= 50 ? '#ffc107' : '#dc3545'};">${record.percentage}%</td>
                        </tr>
                    `;
                });

                const certificateHTML = `
                    <div id="printableAttendanceCertificate" class="certificate-container">
                        <div class="certificate-header">
                            <div class="header-flex">
                                <img src="logo.png" alt="School Logo" class="school-logo" onerror="this.style.display='none'">
                                <div class="school-info">
                                    <h1 class="school-name">VISWA BHARATHI HIGH SCHOOL</h1>
                                    <p class="school-address">NEHRU ROAD, PRODDATUR-516 360. Kadapa Dist. (A.P.)</p>
                                    <p class="school-address">Cell: 6301444214, 8555950709</p>
                                </div>
                            </div>
                            <h2 class="certificate-title">ATTENDANCE CERTIFICATE</h2>
                        </div>
                        <div class="certificate-body">
                            <div class="certificate-section">
                                <p><strong>Certificate No:</strong> AC${Date.now()}</p>
                                <p><strong>Date of Issue:</strong> ${currentDate}</p>
                                <p><strong>Academic Year:</strong> ${currentYear}</p>
                            </div>
                            <div class="certificate-section">
                                <h3>STUDENT DETAILS</h3>
                                <p><strong>Student Name:</strong> ${studentName || 'N/A'}</p>
                                <p><strong>Student Code:</strong> ${studentCode}</p>
                                <p><strong>Roll Number:</strong> ${studentRoll}</p>
                                <p><strong>Class:</strong> ${studentClass.toUpperCase()}</p>
                            </div>
                            <div class="certificate-section">
                                <h3>OVERALL ATTENDANCE SUMMARY</h3>
                                <div class="attendance-stats">
                                    <div class="stat-card">
                                        <div class="stat-value">${totalWorkingDays}</div>
                                        <div class="stat-label">Total Working Days</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${totalAttendedDays}</div>
                                        <div class="stat-label">Days Attended</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" style="color: ${overallPercentage >= 75 ? '#28a745' : overallPercentage >= 50 ? '#ffc107' : '#dc3545'};">${overallPercentage}%</div>
                                        <div class="stat-label">Overall Percentage</div>
                                    </div>
                                </div>
                            </div>
                            <div class="certificate-section">
                                <h3>MONTHLY ATTENDANCE BREAKDOWN</h3>
                                <table class="certificate-table">
                                    <tr>
                                        <th>Month</th>
                                        <th>Working Days</th>
                                        <th>Days Present</th>
                                        <th>Percentage</th>
                                    </tr>
                                    ${monthlyBreakdown}
                                </table>
                            </div>
                            <div class="certificate-footer">
                                <div class="signature-line"></div>
                                <p class="signature-text">Principal</p>
                                <p class="signature-title">Viswabharathi School</p>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('attendanceDetailContent').innerHTML = certificateHTML;
                document.getElementById('attendanceDetailModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading attendance certificate:', error);
                alert('Error loading attendance certificate: ' + error.message);
            }
        }

        function printAttendanceCertificate() {
            const printContents = document.getElementById('printableAttendanceCertificate').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Attendance Certificate - Viswabharathi School</title>
                        <style>
                            body { font-family: 'Times New Roman', serif; margin: 0; padding: 20px; }
                            .certificate-container { border: 2px solid #000; padding: 40px; }
                            .certificate-header { border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
                            .header-flex { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
                            .school-logo { width: 100px; height: 100px; flex-shrink: 0; object-fit: contain; }
                            .school-info { flex: 1; text-align: left; }
                            .school-name { font-size: 28px; font-weight: bold; margin: 0 0 10px 0; color: rgb(52,164,220); }
                            .school-address { margin: 5px 0; font-size: 14px; color: #666; }
                            .certificate-title { font-size: 24px; color: #000; margin: 15px 0 0 0; text-align: center; text-decoration: underline; }
                            .certificate-section { margin-bottom: 25px; }
                            .certificate-section h3 { border-bottom: 1px solid #000; padding-bottom: 5px; }
                            .certificate-table { width: 100%; border-collapse: collapse; }
                            .certificate-table th, .certificate-table td { border: 1px solid #000; padding: 12px; }
                            .certificate-table th { background-color: #f0f0f0; }
                            .attendance-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
                            .stat-card { background: #f8f9fa; padding: 20px; border: 1px solid #000; text-align: center; }
                            .stat-value { font-size: 28px; font-weight: bold; }
                            .stat-label { font-size: 14px; margin-top: 5px; }
                            .certificate-footer { text-align: right; margin-top: 40px; }
                            .signature-line { border-top: 2px solid #000; width: 200px; margin: 0 0 5px auto; }
                            @media print { body { padding: 0; } }
                        </style>
                    </head>
                    <body>
                        ${printContents}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function closeAttendanceDetail() {
            document.getElementById('attendanceDetailModal').style.display = 'none';
        }

        // Progress Card Functions
        async function loadMyProgressCard() {
            try {
                const response = await fetch(`${API_BASE}/progress-cards/${studentClass}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        document.getElementById('myProgressCard').innerHTML = '<div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px;">No progress card available yet.</div>';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const allProgressCards = await response.json();
                const myProgressCards = allProgressCards.filter(card => 
                    card.rollNumber === studentRoll || card.studentCode === studentCode.toUpperCase()
                );
                
                let html = '';
                if (myProgressCards.length > 0) {
                    myProgressCards.forEach(card => {
                        const performance = card.performance || calculatePerformance(card.percentage);
                        html += `
                            <div class="progress-card" onclick="showProgressDetail('${card.id}')" 
                                 style="cursor: pointer; margin: 10px 0; padding: 15px; border: 2px solid ${performance.color}; border-radius: 8px; background: #fff; transition: all 0.3s;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" onmouseout="this.style.boxShadow='none'">
                                <h4 style="color: ${performance.color};">${performance.emoji} ${card.examType}</h4>
                                <p>Total: ${card.obtainedMarks}/${card.totalMarks} (${card.percentage}%) - Grade: ${performance.grade}</p>
                                <p>Date: ${new Date(card.postingDate || card.date).toLocaleDateString()}</p>
                                <small style="color: #666;">Click to view certificate</small>
                            </div>
                        `;
                    });
                } else {
                      html = '<div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px;">No progress card available yet.</div>';
                }
                
                document.getElementById('myProgressCard').innerHTML = html;
            } catch (error) {
                console.error('Error loading progress card:', error);
                document.getElementById('myProgressCard').innerHTML = '<div class="error" style="color: #dc3545; text-align: center; padding: 20px;">Error loading progress card: ' + error.message + '</div>';
            }
        }

        function calculatePerformance(percentage) {
            if (percentage >= 90) return { grade: 'SUPER', color: '#28a745', emoji: 'üåü' };
            if (percentage >= 75) return { grade: 'EXCELLENT', color: '#17a2b8', emoji: '‚≠ê' };
            if (percentage >= 60) return { grade: 'GOOD', color: '#007bff', emoji: 'üëç' };
            if (percentage >= 50) return { grade: 'AVERAGE', color: '#ffc107', emoji: 'üìö' };
            if (percentage >= 35) return { grade: 'BELOW AVERAGE', color: '#fd7e14', emoji: 'üìñ' };
            return { grade: 'NEEDS IMPROVEMENT', color: '#dc3545', emoji: 'üí™' };
        }

        function getGrade(percentage) {
            if (percentage >= 90) return 'A+';
            if (percentage >= 80) return 'A';
            if (percentage >= 70) return 'B';
            if (percentage >= 60) return 'C';
            if (percentage >= 50) return 'D';
            return 'F';
        }

        function getGradeColor(percentage) {
            if (percentage >= 80) return '#28a745';
            if (percentage >= 60) return '#ffc107';
            return '#dc3545';
        }

       async function showProgressDetail(cardId) {
            try {
                const response = await fetch(`${API_BASE}/progress-cards/${studentClass}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const progressCards = await response.json();
                const card = progressCards.find(c => c.id == cardId);
                
                if (!card) {
                    alert('Progress card not found');
                    return;
                }

                const currentDate = new Date().toLocaleDateString('en-IN');
                const performance = card.performance || calculatePerformance(card.percentage);

                let subjectsHTML = '';
                if (card.subjects && typeof card.subjects === 'object') {
                    Object.entries(card.subjects).forEach(([subject, data]) => {
                        if (typeof data === 'object' && data.maxMarks !== undefined) {
                            const subjectPerf = calculatePerformance(parseFloat(data.percentage));
                            subjectsHTML += `
                                <div class="subject-card" style="background: #f8f9fa; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; text-align: center; margin-bottom: 10px;">
                                    <div class="subject-name" style="font-weight: bold; margin-bottom: 5px; text-transform: capitalize;">${subject}</div>
                                    <div class="subject-marks" style="font-size: 20px; font-weight: bold; color: #667eea;">${data.obtainedMarks}/${data.maxMarks}</div>
                                    <div class="subject-percentage" style="font-size: 14px; margin-top: 5px; color: ${subjectPerf.color}; font-weight: bold;">${data.percentage}% - ${subjectPerf.grade}</div>
                                </div>
                            `;
                        }
                    });
                }

                const certificateHTML = `
                    <div id="printableProgressCard" class="certificate-container">
                        <div class="certificate-header">
                            <div class="header-flex">
                                <img src="logo.png" alt="School Logo" class="school-logo" onerror="this.style.display='none'">
                                <div class="school-info">
                                    <h1 class="school-name">VISWA BHARATHI HIGH SCHOOL</h1>
                                    <p class="school-address">NEHRU ROAD, PRODDATUR-516 360. Kadapa Dist. (A.P.)</p>
                                    <p class="school-address">Cell: 6301444214, 8555950709</p>
                                </div>
                            </div>
                            <h2 class="certificate-title">PROGRESS CARD</h2>
                        </div>
                        <div class="certificate-body">
                            <div class="certificate-section">
                                <p><strong>Report Card No:</strong> RC${card.id}</p>
                                <p><strong>Date of Issue:</strong> ${currentDate}</p>
                                <p><strong>Exam Type:</strong> ${card.examType}</p>
                            </div>
                            <div class="certificate-section">
                                <h3>STUDENT DETAILS</h3>
                                <p><strong>Student Name:</strong> ${card.fullName}</p>
                                <p><strong>Student Code:</strong> ${card.studentCode}</p>
                                <p><strong>Roll Number:</strong> ${card.rollNumber}</p>
                                <p><strong>Father's Name:</strong> ${card.fatherName}</p>
                                <p><strong>Class:</strong> ${card.classCode.toUpperCase()}</p>
                            </div>
                            <div class="certificate-section">
                                <h3>SUBJECT-WISE MARKS</h3>
                                <div class="subjects-grid">
                                    ${subjectsHTML}
                                </div>
                            </div>
                            <div class="certificate-section">
                                <h3>OVERALL PERFORMANCE</h3>
                                <div class="grade-display" style="background: ${performance.color}; color: white; text-align: center; padding: 20px; border-radius: 8px;">
                                    <h2 style="margin: 0; font-size: 48px;">${performance.emoji} ${performance.grade}</h2>
                                    <p style="font-size: 18px; margin: 10px 0;">Total Marks: ${card.obtainedMarks}/${card.totalMarks}</p>
                                    <p style="font-size: 20px; margin: 10px 0;">Percentage: ${card.percentage}%</p>
                                </div>
                            </div>
                            <div class="certificate-footer">
                                <div class="signature-line"></div>
                                <p class="signature-text">Principal</p>
                                <p class="signature-title">Viswabharathi School</p>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('progressDetailContent').innerHTML = certificateHTML;
                document.getElementById('progressDetailModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading progress card details:', error);
                alert('Error loading progress card details: ' + error.message);
            }
        }

        function printProgressCard() {
            const printContents = document.getElementById('printableProgressCard').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Progress Card - Viswabharathi School</title>
                        <style>
                            body { font-family: 'Times New Roman', serif; margin: 0; padding: 20px; }
                            .certificate-container { border: 2px solid #000; padding: 40px; }
                            .certificate-header { border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
                            .header-flex { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
                            .school-logo { width: 100px; height: 100px; flex-shrink: 0; object-fit: contain; }
                            .school-info { flex: 1; text-align: left; }
                            .school-name { font-size: 28px; font-weight: bold; margin: 0 0 10px 0; color: rgb(52,164,220); }
                            .school-address { margin: 5px 0; font-size: 14px; color: #666; }
                            .certificate-title { font-size: 24px; color: #000; margin: 15px 0 0 0; text-align: center; text-decoration: underline; }
                            .certificate-section { margin-bottom: 25px; }
                            .certificate-section h3 { border-bottom: 1px solid #000; padding-bottom: 5px; }
                            .subjects-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
                            .subject-card { background: #f8f9fa; padding: 15px; border: 1px solid #000; text-align: center; }
                            .subject-name { font-weight: bold; margin-bottom: 5px; text-transform: capitalize; }
                            .subject-marks { font-size: 20px; font-weight: bold; }
                            .grade-display { text-align: center; padding: 20px; background: #f0f0f0 !important; color: #000 !important; border: 2px solid #000; margin: 20px 0; }
                            .grade-display h2 { margin: 0; font-size: 36px; }
                            .certificate-footer { text-align: right; margin-top: 40px; }
                            .signature-line { border-top: 2px solid #000; width: 200px; margin: 0 0 5px auto; }
                            @media print { body { padding: 0; } }
                        </style>
                    </head>
                    <body>
                        ${printContents}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function closeProgressDetail() {
            document.getElementById('progressDetailModal').style.display = 'none';
        }

        // Assignment Functions
        async function loadAssignments() {
            try {
                const response = await fetch(`${API_BASE}/assignments/${studentClass}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const assignments = await response.json();
                
                let html = '';
                if (assignments.length > 0) {
                    for (const assignment of assignments) {
                        try {
                            const resultsResponse = await fetch(`${API_BASE}/assignment-results/${assignment.id}`);
                            const results = resultsResponse.ok ? await resultsResponse.json() : [];
                            const hasSubmitted = results.some(r => r.studentCode === studentCode.toUpperCase());
                            
                            const statusBadge = hasSubmitted ? 
                                '<span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px;">Completed</span>' : 
                                '<span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px;">Active</span>';
                            
                            // Fix date display issue
                            const assignmentDateDisplay = assignment.assignmentDate ? 
                                new Date(assignment.assignmentDate).toLocaleDateString('en-IN') : 
                                'Not specified';
                            
                            html += `
                                <div class="assignment-item" style="margin: 15px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fff;">
                                    <h4>${assignment.title} ${statusBadge}</h4>
                                    <p>Assignment Date: ${assignmentDateDisplay}</p>
                                    <p>Created: ${new Date(assignment.date).toLocaleDateString('en-IN')}</p>
                                    <p>Questions: ${assignment.questions.length}</p>
                                    ${hasSubmitted ? 
                                        '<p style="color: #28a745; font-weight: bold;">You have already completed this assignment</p>' :
                                        `<button onclick="takeAssignment('${assignment.id}')" class="success-btn">Take Assignment</button>`
                                    }
                                </div>
                            `;
                        } catch (resultError) {
                            console.error('Error loading results for assignment:', assignment.id, resultError);
                            const assignmentDateDisplay = assignment.assignmentDate ? 
                                new Date(assignment.assignmentDate).toLocaleDateString('en-IN') : 
                                'Not specified';
                            
                            html += `
                                <div class="assignment-item" style="margin: 15px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fff;">
                                    <h4>${assignment.title} <span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px;">Active</span></h4>
                                    <p>Assignment Date: ${assignmentDateDisplay}</p>
                                    <p>Created: ${new Date(assignment.date).toLocaleDateString('en-IN')}</p>
                                    <p>Questions: ${assignment.questions.length}</p>
                                    <button onclick="takeAssignment('${assignment.id}')" class="success-btn">Take Assignment</button>
                                </div>
                            `;
                        }
                    }
                } else {
                    html = '<div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px;">No assignments available for your class</div>';
                }
                
                document.getElementById('assignmentsList').innerHTML = html;
            } catch (error) {
                console.error('Error loading assignments:', error);
                document.getElementById('assignmentsList').innerHTML = '<p style="color: #dc3545; text-align: center;">Error loading assignments: ' + error.message + '</p>';
            }
        }

        async function takeAssignment(assignmentId) {
            try {
                const response = await fetch(`${API_BASE}/assignments/${studentClass}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const assignments = await response.json();
                const assignment = assignments.find(a => a.id == assignmentId);
                
                if (!assignment) {
                    alert('Assignment not found');
                    return;
                }

                currentAssignment = assignment;
                startTime = new Date();

                let html = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3>${assignment.title}</h3>
                        <p>Total Questions: ${assignment.questions.length}</p>
                    </div>
                    <form id="assignmentSubmissionForm">
                `;

                assignment.questions.forEach((question, index) => {
                    html += `
                        <div style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                            <h4>Question ${index + 1}</h4>
                            <p>${question.question}</p>
                            <div>
                                <label style="display: block; margin: 8px 0;"><input type="radio" name="answer_${index}" value="a" required> A) ${question.options.a}</label>
                                <label style="display: block; margin: 8px 0;"><input type="radio" name="answer_${index}" value="b"> B) ${question.options.b}</label>
                                <label style="display: block; margin: 8px 0;"><input type="radio" name="answer_${index}" value="c"> C) ${question.options.c}</label>
                                <label style="display: block; margin: 8px 0;"><input type="radio" name="answer_${index}" value="d"> D) ${question.options.d}</label>
                            </div>
                        </div>
                    `;
                });

                html += `
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="success-btn">Submit Assignment</button>
                        <button type="button" onclick="closeAssignmentModal()" class="danger-btn">Cancel</button>
                    </div>
                    </form>
                `;

                document.getElementById('assignmentContent').innerHTML = html;
                document.getElementById('assignmentModal').style.display = 'block';

                document.getElementById('assignmentSubmissionForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitAssignment(this);
                });

            } catch (error) {
                console.error('Error loading assignment:', error);
                alert('Error loading assignment: ' + error.message);
            }
        }

        async function submitAssignment(form) {
            if (!confirm('Are you sure you want to submit?')) {
                return;
            }

            try {
                const formData = new FormData(form);
                const answers = [];
                
                for (let i = 0; i < currentAssignment.questions.length; i++) {
                    answers.push(formData.get(`answer_${i}`) || null);
                }

                const response = await fetch(`${API_BASE}/submit-assignment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        assignmentId: currentAssignment.id,
                        classCode: studentClass,
                        studentCode: studentCode,
                        answers: answers
                    })
                });

                const result = await response.json();
                if (result.success) {
                    closeAssignmentModal();
                    showResults(result.submission);
                    loadAssignments();
                } else {
                    throw new Error(result.error || 'Failed to submit assignment');
                }

            } catch (error) {
                console.error('Error submitting assignment:', error);
                alert('Error submitting assignment: ' + error.message);
            }
        }

        function closeAssignmentModal() {
            document.getElementById('assignmentModal').style.display = 'none';
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            currentAssignment = null;
            startTime = null;
        }

        function showResults(submission) {
            const percentage = submission.percentage;
            let grade = 'F';
            let gradeColor = '#dc3545';
            
            if (percentage >= 90) { grade = 'A+'; gradeColor = '#28a745'; }
            else if (percentage >= 80) { grade = 'A'; gradeColor = '#28a745'; }
            else if (percentage >= 70) { grade = 'B'; gradeColor = '#ffc107'; }
            else if (percentage >= 60) { grade = 'C'; gradeColor = '#fd7e14'; }
            else if (percentage >= 50) { grade = 'D'; gradeColor = '#dc3545'; }

            let html = `
                <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                    <h4>Your Score: ${submission.score}/${submission.totalQuestions}</h4>
                    <p>Percentage: ${percentage}%</p>
                    <p style="color: ${gradeColor};">Grade: ${grade}</p>
                    <p>Submitted: ${new Date(submission.submittedAt).toLocaleString()}</p>
                </div>
                <h4>Detailed Results:</h4>
            `;

            submission.results.forEach((result, index) => {
                const icon = result.isCorrect ? '‚úì' : '‚úó';
                const bgColor = result.isCorrect ? '#d4edda' : '#f8d7da';
                const borderColor = result.isCorrect ? '#c3e6cb' : '#f5c6cb';
                
                html += `
                    <div style="margin: 15px 0; padding: 15px; border: 1px solid ${borderColor}; border-radius: 8px; background: ${bgColor};">
                        <p><strong>Question ${index + 1}:</strong> ${result.question}</p>
                        <p><strong>Your Answer:</strong> ${result.studentAnswer ? result.studentAnswer.toUpperCase() + ') ' + result.options[result.studentAnswer] : 'Not answered'}</p>
                        <p><strong>Correct Answer:</strong> ${result.correctAnswer.toUpperCase()}) ${result.options[result.correctAnswer]}</p>
                        <p><strong>Result:</strong> ${icon} ${result.isCorrect ? 'Correct' : 'Incorrect'}</p>
                    </div>
                `;
            });

            document.getElementById('resultsContent').innerHTML = html;
            document.getElementById('resultsModal').style.display = 'block';
        }

        function closeResults() {
            document.getElementById('resultsModal').style.display = 'none';
        }

        async function viewMyResults() {
            try {
                const response = await fetch(`${API_BASE}/assignments/${studentClass}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const assignments = await response.json();
                
                let html = '';
                let hasResults = false;
                
                for (const assignment of assignments) {
                    try {
                        const resultsResponse = await fetch(`${API_BASE}/assignment-results/${assignment.id}`);
                        if (resultsResponse.ok) {
                            const allResults = await resultsResponse.json();
                            const myResult = allResults.find(r => r.studentCode === studentCode.toUpperCase());
                            
                            if (myResult) {
                                hasResults = true;
                                html += `
                                    <div style="margin: 15px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                                        <h4>${assignment.title}</h4>
                                        <p>Score: ${myResult.score}/${myResult.totalQuestions} (${myResult.percentage}%)</p>
                                        <p>Submitted: ${new Date(myResult.submittedAt).toLocaleString()}</p>
                                        <button onclick="viewDetailedResult('${assignment.id}')" class="success-btn">View Details</button>
                                    </div>
                                `;
                            }
                        }
                    } catch (resultError) {
                        console.error('Error loading results for assignment:', assignment.id, resultError);
                    }
                }
                
                if (!hasResults) {
                    html = '<div style="text-align: center; padding: 20px;">You haven\'t taken any assignments yet</div>';
                }
                
                document.getElementById('myResultsContent').innerHTML = html;
                document.getElementById('myResultsModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading results:', error);
                document.getElementById('myResultsContent').innerHTML = '<p style="color: #dc3545;">Error loading your results: ' + error.message + '</p>';
                document.getElementById('myResultsModal').style.display = 'block';
            }
        }

        async function viewDetailedResult(assignmentId) {
            try {
                const resultsResponse = await fetch(`${API_BASE}/assignment-results/${assignmentId}`);
                if (!resultsResponse.ok) {
                    throw new Error(`HTTP ${resultsResponse.status}`);
                }
                
                const results = await resultsResponse.json();
                const result = results.find(r => r.studentCode === studentCode.toUpperCase());
                
                if (result) {
                    closeMyResults();
                    showResults(result);
                } else {
                    alert('Result not found');
                }
            } catch (error) {
                console.error('Error loading detailed result:', error);
                alert('Error loading detailed result: ' + error.message);
            }
        }

        function closeMyResults() {
            document.getElementById('myResultsModal').style.display = 'none';
        }

        // Data Loading Functions
        async function loadData() {
            try {
                const response = await fetch(`${API_BASE}/student-data/${studentCode}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                displayFacultyPosts(data);
            } catch (error) {
                console.error('Error loading student data:', error);
                loadDataFallback();
            }
        }

        async function loadDataFallback() {
            try {
                const response = await fetch(`${API_BASE}/data`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                const classFacultyPosts = data.facultyPosts[studentClass] || {
                    homework: [],
                    assignment: [],
                    subject: []
                };
                
                const filteredData = {
                    facultyPosts: classFacultyPosts
                };
                
                displayFacultyPosts(filteredData);
            } catch (error) {
                console.error('Error loading fallback data:', error);
                document.getElementById('facultyPosts').innerHTML = '<p style="color: #dc3545;">Error loading faculty posts: ' + error.message + '</p>';
            }
        }

        function displayFacultyPosts(data) {
            let html = '';
            
            if (data.facultyPosts) {
                html += '<h3>Homework</h3>';
                if (data.facultyPosts.homework && data.facultyPosts.homework.length > 0) {
                    data.facultyPosts.homework.slice().reverse().forEach(post => {
                        html += `
                            <div style="margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fff;">
                                <strong>${post.date} (${post.faculty}):</strong> ${post.text}
                                ${post.file ? `<br><a href="${post.file}" target="_blank" style="color: #007bff; text-decoration: none;">üìé ${post.fileName}</a>` : ''}
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #666; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px;">No homework assignments</p>';
                }
                
                html += '<h3 style="margin-top: 30px;">Assignments</h3>';
                if (data.facultyPosts.assignment && data.facultyPosts.assignment.length > 0) {
                    data.facultyPosts.assignment.slice().reverse().forEach(post => {
                        html += `
                            <div style="margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fff;">
                                <strong>${post.date} (${post.faculty}):</strong> ${post.text}
                                ${post.file ? `<br><a href="${post.file}" target="_blank" style="color: #007bff; text-decoration: none;">üìé ${post.fileName}</a>` : ''}
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #666; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px;">No assignments</p>';
                }
                
                html += '<h3 style="margin-top: 30px;">Subject Information</h3>';
                if (data.facultyPosts.subject && data.facultyPosts.subject.length > 0) {
                    data.facultyPosts.subject.slice().reverse().forEach(post => {
                        html += `
                            <div style="margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fff;">
                                <strong>${post.date} (${post.faculty}):</strong> ${post.text}
                                ${post.file ? `<br><a href="${post.file}" target="_blank" style="color: #007bff; text-decoration: none;">üìé ${post.fileName}</a>` : ''}
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #666; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px;">No subject information</p>';
                }
            } else {
                html = '<p style="color: #666; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px;">No faculty posts found for your class</p>';
            }

            document.getElementById('facultyPosts').innerHTML = html;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = ['assignmentModal', 'resultsModal', 'myResultsModal', 'progressDetailModal', 'attendanceDetailModal', 'feeCertificateModal', 'hallTicketDetailModal', 'profileModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && event.target === modal) {
                    modal.style.display = 'none';
                    if (modalId === 'assignmentModal') {
                        closeAssignmentModal();
                    }
                }
            });
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (notificationCheckInterval) {
                clearInterval(notificationCheckInterval);
            }
        });

        // Initialize on page load
        window.onload = function() {
            try {
                if (initializeStudent()) {
                    loadData();
                    loadAssignments();
                    loadMyProgressCard();
                    loadMyAttendance();
                    
                    // Initialize notification system
                    initializeNotificationSystem();
                }
            } catch (error) {
                console.error('Error during initialization:', error);
                alert('Error initializing student dashboard: ' + error.message);
                window.location.href = 'index.html';
            }
        };
    </script>
</body>
</html>
